'use strict';

angular.module('insight.address').controller('AddressController',
    function ($scope, $rootScope, $routeParams, $location, Global, Address, getSocket , AddressLabel) {
        $scope.global = Global;
        $scope.AddressLabel = AddressLabel;
        $scope.loading = true;

        var socket = getSocket($scope);
        var addrStr = $routeParams.addrStr;
        var assetId = $routeParams.assetId;
        var _startSocket = function () {
            socket.on('bitcoind/addresstxid', function (data) {
                if (data.address === addrStr) {
                    $rootScope.$broadcast('tx', data.txid);
                    // var base = document.querySelector('base');
                    // var beep = new Audio(base.href + '/sound/transaction.mp3');
                    // beep.play();
                }
            });
            socket.emit('subscribe', 'bitcoind/addresstxid', [addrStr]);
        };

        var _stopSocket = function () {
            socket.emit('unsubscribe', 'bitcoind/addresstxid', [addrStr]);
        };

        socket.on('connect', function () {
            _startSocket();
        });

        $scope.$on('$destroy', function () {
            _stopSocket();
        });
        $scope.params = $routeParams;
        $scope.findOne = function () {
            $rootScope.currentAddr = addrStr;
            _startSocket();
            Address.get({
                    addrStr: $routeParams.addrStr,
                    assetsId: assetId || ""
                },
                function (address) {
                    var shortName = " SAFE";
                    if (assetId) {
                        for (var i = 0; i < address.assets.length; i++) {
                            if (address.assets[i].assetId == assetId) {
                                shortName = " " + address.assets[i].shortName;
                                break;
                            }
                        }
                    }
                    address.assets.unshift({
                        "shortName": "SAFE",
                        "assetId": ""
                    });
                    $scope.address = address;
                    $scope.assetId = assetId;
                    $scope.shortName = shortName;
                    $scope.loading = false;
                },
                function (e) {
                    if (e.status === 400) {
                        $rootScope.flashMessage = 'Invalid Address: ' + $routeParams.addrStr;
                    } else if (e.status === 503) {
                        $rootScope.flashMessage = 'Backend Error. ' + e.data;
                    } else {
                        $rootScope.flashMessage = 'Address Not Found';
                    }
                    $location.path('/');
                });
        };

        //跳转界面
        $scope.addressGetTxByAssetsId = function () { //根据资产id显示当前地址的资产交易
            var assetId = $scope.assetsId;
            if (!assetId)
                assetId = "all";
            $location.path('/addressAssets/' + addrStr + '/' + assetId);
        };
        //获取资产id
        $scope.$watch("assetsId", function (assetsId) {
            $scope.assetsId = assetsId;
        })
    });